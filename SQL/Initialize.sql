-- As DB admin:
-- CREATE EXTENSION IF NOT EXISTS citext;  
-- CREATE EXTENSION IF NOT EXISTS pgcrypto;  


DROP TABLE INVITATION_CODE;
DROP TABLE LOGIN_TOKENS;
DROP TABLE RATE_LIMITER;
DROP TABLE LOGIN_ATTEMPT;
DROP TABLE PICTURES;
DROP TABLE APPUSER;

CREATE TABLE APPUSER (
    ID               SERIAL        PRIMARY KEY,
    CREATED_AT       TIMESTAMP     DEFAULT CURRENT_TIMESTAMP,
    USERNAME         CITEXT        UNIQUE,
    EMAIL            CITEXT        UNIQUE,
    ROLE             INTEGER       DEFAULT 0,
    PASSWORD         VARCHAR(1024),
    VALIDATED        BOOL          DEFAULT false,
    VALIDATION_TOKEN VARCHAR(36)   DEFAULT gen_random_uuid(),
    INVITED_BY       INTEGER       REFERENCES APPUSER(ID)
);

-- Default password is 'password'
INSERT INTO APPUSER (EMAIL, USERNAME, PASSWORD, ROLE, VALIDATED) VALUES ('admin@scinna.dev', 'admin', '$argon2id$v=19$m=65536,t=3,p=2$D1hPKoAbrexDtJd6uEf3Cg$d1puA1YPJgUkvvTaotKpRWOT2xIMMIUknyl6IeWJsfQ', 1, true);

CREATE TABLE PICTURES (
    ID         SERIAL         PRIMARY KEY,
    CREATED_AT TIMESTAMP      DEFAULT CURRENT_TIMESTAMP,
    TITLE      VARCHAR(128),
    URL_ID     VARCHAR(30),
    DESCRIPT   VARCHAR(1024),
    VISIBILITY INTEGER,
    CREATOR    INTEGER        REFERENCES APPUSER(ID),
    EXT        VARCHAR(8)
);

CREATE TABLE LOGIN_ATTEMPT (
    ID           INTEGER      REFERENCES APPUSER(ID),
    CREATED_AT   TIMESTAMP    DEFAULT CURRENT_TIMESTAMP,
    IP           VARCHAR(45),
    PRIMARY KEY (ID, CREATED_AT)
);

CREATE TABLE LOGIN_TOKENS (
    ID         SERIAL PRIMARY KEY UNIQUE,
    CREATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    ID_USR     INTEGER REFERENCES APPUSER(ID),
    TOKEN      UUID DEFAULT gen_random_uuid() UNIQUE,
    IP         VARCHAR(45),
    REVOKED    BOOL DEFAULT false,
    REVOKED_AT TIMESTAMP
);

CREATE TABLE RATE_LIMITER (
    IP VARCHAR(45) PRIMARY KEY UNIQUE,
    STARTING_TIME TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    AMT_REQ INT
);

CREATE TABLE INVITATION_CODE (
    ID SERIAL PRIMARY KEY UNIQUE,
    CREATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    GENERATED_BY INTEGER REFERENCES APPUSER(ID),
    CODE VARCHAR(32)
);