-- As DB admin:
CREATE EXTENSION IF NOT EXISTS citext;
CREATE EXTENSION IF NOT EXISTS pgcrypto;
CREATE EXTENSION IF NOT EXISTS "uuid-ossp";

DROP TABLE MEDIA;
DROP TABLE INVITE_CODE;
DROP TABLE LOGIN_TOKENS;
DROP TABLE SCINNA_USER;
DROP TABLE DBVERSION;

CREATE TABLE DBVERSION (
    VERSION VARCHAR
);

INSERT INTO DBVERSION (VERSION) VALUES ('0.1');

CREATE TABLE SCINNA_USER (
    USER_ID         uuid         PRIMARY KEY default uuid_generate_v4(),
    USER_NAME       VARCHAR(30)  UNIQUE NOT NULL,
    USER_EMAIL      VARCHAR(255) UNIQUE NOT NULL,
    USER_PASSWORD   VARCHAR      NOT NULL,

    INVITATION_CODE VARCHAR(10)  DEFAULT NULL,

    VALIDATED       BOOL         NOT NULL DEFAULT FALSE,
    VALIDATION_CODE VARCHAR      NULL DEFAULT uuid_generate_v4(),
    REGISTERED_AT   TIMESTAMP    DEFAULT NOW()
);

CREATE TABLE INVITE_CODE (
    INVITE_CODE VARCHAR(10) PRIMARY KEY NOT NULL,
    INVITED_BY  INTEGER,
    USED        BOOL DEFAULT FALSE
);

CREATE TABLE LOGIN_TOKENS (
  LOGIN_TOKEN uuid DEFAULT uuid_generate_v4(),
  USER_ID     uuid REFERENCES SCINNA_USER(USER_ID) NOT NULL,
  USER_IP     VARCHAR NOT NULL,
  LOGIN_TIME  TIMESTAMP DEFAULT CURRENT_TIMESTAMP NOT NULL,
  REVOKED_AT  TIMESTAMP DEFAULT NULL,
  PRIMARY KEY (LOGIN_TOKEN)
);

CREATE TABLE MEDIA (
    MEDIA_ID    VARCHAR(10) PRIMARY KEY,
    USER_ID     uuid REFERENCES SCINNA_USER(USER_ID) NOT NULL,
    TITLE       VARCHAR,
    DESCRIPTION VARCHAR,
    PATH        VARCHAR,
    VISIBILITY  INTEGER,
    MIMETYPE    VARCHAR
);

